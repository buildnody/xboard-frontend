@if (userState.loading()) {
  <div class="flex justify-center items-center h-full">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-accent-start"></div>
  </div>
} @else if (userState.error()) {
  <div class="bg-red-900/30 border border-red-500/50 text-red-400 px-4 py-3 rounded-xl" role="alert">
    <strong class="font-bold">错误!</strong>
    <span class="block sm:inline">{{ userState.error() }}</span>
  </div>
} @else if (userInfo(); as user) {
  <div class="space-y-10">
    
    <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised">
        <h3 class="text-lg font-semibold text-text-main mb-6">公告</h3>
        <div class="space-y-4 max-h-60 overflow-y-auto pr-2">
            @if (loadingNotices()) {
                <p class="text-text-muted">加载中...</p>
            } @else if (notices().length > 0) {
                @for (notice of notices(); track notice.id) {
                    <div class="p-4 bg-dark rounded-xl shadow-neumorphic-sunken border-l-4 border-accent-start cursor-pointer hover:bg-dark/60 transition-colors" (click)="openNoticeModal(notice)">
                        <h4 class="font-bold text-text-main">{{ notice.title }}</h4>
                        <p class="mt-1 text-sm text-text-muted truncate">{{ getSubtitle(notice.content) }}</p>
                    </div>
                }
            } @else {
                <p class="text-text-muted">暂无公告。</p>
            }
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
      <div class="bg-surface p-6 rounded-2xl shadow-neumorphic-raised">
        <h3 class="text-sm font-medium text-text-muted">当前套餐</h3>
        <p class="mt-2 text-2xl font-semibold text-text-main">{{ currentPlan()?.name || '无' }}</p>
      </div>
      <div class="bg-surface p-6 rounded-2xl shadow-neumorphic-raised">
        <h3 class="text-sm font-medium text-text-muted">到期时间</h3>
        <p class="mt-2 text-2xl font-semibold text-text-main">
          @if (user.expired_at === null) {
            永久
          } @else if (user.expired_at > 0) {
            {{ user.expired_at * 1000 | date:'yyyy-MM-dd' }}
          } @else {
            无
          }
        </p>
      </div>
      <a routerLink="/app/profile" class="block bg-surface p-6 rounded-2xl shadow-neumorphic-raised hover:shadow-neumorphic-pressed transition-shadow duration-200">
        <h3 class="text-sm font-medium text-text-muted">账户余额</h3>
        <p class="mt-2 text-2xl font-semibold text-text-main">
          ¥ {{ (user.balance / 100).toFixed(2) }}
        </p>
      </a>
       <a routerLink="/app/tickets" class="block bg-surface p-6 rounded-2xl shadow-neumorphic-raised hover:shadow-neumorphic-pressed transition-shadow duration-200">
        <h3 class="text-sm font-medium text-text-muted">待办工单</h3>
        <p class="mt-2 text-2xl font-semibold text-text-main">
          {{ pendingTicketsCount() }} 个
        </p>
      </a>
    </div>
    
    <!-- Grid container for Traffic and Subscription Link -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
      
      <!-- Traffic Usage Card -->
      <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised flex flex-col">
        <h3 class="text-lg font-semibold text-text-main">流量使用情况</h3>
        <div class="mt-6 flex-grow min-h-[200px]">
          @defer (on viewport) {
            <app-traffic-chart [usedData]="usedData()" [totalData]="totalData()"></app-traffic-chart>
          } @placeholder {
            <div class="flex justify-center items-center h-full text-text-muted">
              加载图表中...
            </div>
          } @loading {
            <div class="flex justify-center items-center h-full">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent-start"></div>
            </div>
          }
        </div>
      </div>

      <!-- Subscription Link Card -->
      <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised flex flex-col">
        <h3 class="text-lg font-semibold text-text-main">订阅链接</h3>
        
        @if (user.plan_id && user.plan_id > 0) {
          <div class="flex flex-col flex-grow justify-between mt-1">
            <p class="text-sm text-text-muted mb-6">将此链接导入到兼容的客户端中以同步节点信息。</p>
            
            <div class="flex flex-col gap-6">
              <!-- URL Input and Copy Button -->
              <div class="flex gap-3">
                <input type="text" [value]="truncatedSubscribeUrl()" readonly 
                      class="flex-grow w-full px-4 py-3 bg-dark text-text-main placeholder-text-muted rounded-xl shadow-neumorphic-sunken focus:outline-none focus:ring-2 focus:ring-accent-start font-mono text-sm">
                <button (click)="copySubscriptionUrl()" [disabled]="!user.subscribe_url"
                        [class.bg-green-500]="copySuccess()" [class.hover:bg-green-600]="copySuccess()"
                        [class.bg-gradient-to-br]="!copySuccess()" [class.from-accent-start]="!copySuccess()" [class.to-accent-end]="!copySuccess()"
                        class="flex-shrink-0 px-5 py-3 rounded-xl font-semibold text-white transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 active:translate-y-0.5 disabled:from-gray-500 disabled:to-gray-600 disabled:shadow-none disabled:cursor-not-allowed shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken">
                    {{ copySuccess() ? '已复制!' : '复制' }}
                </button>
              </div>

              <!-- Actions Grid -->
              <div>
                <h4 class="text-sm font-semibold text-text-muted mb-3">快捷操作</h4>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <a [attr.href]="encodedSubscribeUrl() ? 'clash://install-config?url=' + encodedSubscribeUrl() + '&name=NEKO' : null" 
                     [class.opacity-50]="!encodedSubscribeUrl()" [class.pointer-events-none]="!encodedSubscribeUrl()"
                     class="flex flex-col items-center justify-center text-center gap-2 py-3 px-2 rounded-xl text-xs font-medium bg-dark text-text-muted shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken hover:text-text-main transition-all">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H7V8h4v8zm4 0h-2V8h2v8z"></path><path d="M15 8c0-1.66-1.34-3-3-3s-3 1.34-3 3"></path></svg>
                    <span>Clash</span>
                  </a>
                  <a [attr.href]="base64SubscribeUrl() ? 'shadowrocket://add/sub://' + base64SubscribeUrl() + '?remark=NEKO' : null"
                     [class.opacity-50]="!base64SubscribeUrl()" [class.pointer-events-none]="!base64SubscribeUrl()"
                     class="flex flex-col items-center justify-center text-center gap-2 py-3 px-2 rounded-xl text-xs font-medium bg-dark text-text-muted shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken hover:text-text-main transition-all">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"></path></svg>
                    <span>Shadowrocket</span>
                  </a>
                   <a [attr.href]="encodedSubscribeUrl() ? 'stash://install-config?url=' + encodedSubscribeUrl() + '&name=NEKO' : null" 
                     [class.opacity-50]="!encodedSubscribeUrl()" [class.pointer-events-none]="!encodedSubscribeUrl()"
                     class="flex flex-col items-center justify-center text-center gap-2 py-3 px-2 rounded-xl text-xs font-medium bg-dark text-text-muted shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken hover:text-text-main transition-all">
                     <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                    <span>Stash</span>
                  </a>
                  <button (click)="showQrCodeModal.set(true)" [disabled]="!user.subscribe_url"
                          class="flex flex-col items-center justify-center text-center gap-2 py-3 px-2 rounded-xl text-xs font-medium bg-dark text-text-muted shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken hover:text-text-main transition-all disabled:opacity-50 disabled:pointer-events-none">
                    <svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2V4h2v2H5zM3 10a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm2 2v-2h2v2H5zM10 4a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1V4zm2 2V4h2v2h-2zM8 9a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1v-6a1 1 0 00-1-1H8zM9 15v-4h4v4H9z" clip-rule="evenodd"></path></svg>
                    <span>二维码</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        } @else {
            <div class="flex flex-col items-center justify-center text-center h-full p-4 bg-dark rounded-xl shadow-neumorphic-sunken mt-6">
                <svg class="w-16 h-16 text-text-muted/40 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                </svg>
                <h4 class="font-semibold text-text-main">解锁订阅功能</h4>
                <p class="text-text-muted mt-2 text-sm max-w-xs">购买套餐后，您将获得专属订阅链接，<br>轻松配置所有客户端。</p>
                <a routerLink="/app/plans" 
                    class="mt-6 inline-block py-2.5 px-6 rounded-xl font-semibold text-white bg-gradient-to-br from-accent-start to-accent-end shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken transition-all">
                    查看订阅计划
                </a>
            </div>
        }
      </div>
    </div>
  </div>
}

<!-- Announcement Modal -->
@if (selectedNotice(); as notice) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4" (click)="closeNoticeModal()">
    <div class="bg-surface rounded-2xl shadow-neumorphic-raised w-full max-w-2xl max-h-[80vh] flex flex-col" (click)="$event.stopPropagation()">
      <div class="p-6 flex justify-between items-center flex-shrink-0">
        <h2 class="text-xl font-bold text-text-main">{{ notice.title }}</h2>
        <button (click)="closeNoticeModal()" class="text-text-muted hover:text-text-main transition-colors">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-6 overflow-y-auto border-y border-dark">
        <app-markdown-viewer [content]="notice.content"></app-markdown-viewer>
      </div>
      <div class="p-4 text-right flex-shrink-0">
        <button (click)="closeNoticeModal()" class="px-5 py-2 rounded-xl font-semibold text-text-main bg-dark shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken transition-all duration-200">
          关闭
        </button>
      </div>
    </div>
  </div>
}

<!-- QR Code Modal -->
@if (showQrCodeModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4" (click)="showQrCodeModal.set(false)">
    <div class="bg-surface rounded-2xl shadow-neumorphic-raised w-full max-w-sm p-8 text-center" (click)="$event.stopPropagation()">
      <h2 class="text-xl font-bold text-text-main mb-4">扫码订阅</h2>
      <p class="text-text-muted mb-6">请使用兼容的客户端扫描二维码。</p>
      @if(qrCodeData(); as qr) {
        <div class="p-2 bg-white rounded-lg inline-block shadow-lg">
           <img [src]="qr" alt="订阅二维码" class="mx-auto w-56 h-56 rounded-md">
        </div>
      } @else {
        <p class="text-text-muted">无法生成二维码。</p>
      }
      <button (click)="showQrCodeModal.set(false)" class="mt-6 w-full py-2.5 px-4 rounded-xl text-text-main bg-dark/50 hover:bg-dark font-semibold transition-colors">
        关闭
      </button>
    </div>
  </div>
}