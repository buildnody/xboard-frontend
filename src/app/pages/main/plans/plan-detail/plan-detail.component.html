<div class="mb-6">
  <a routerLink="/app/plans" class="inline-flex items-center text-sm font-medium text-accent-start hover:text-accent-end transition-colors">
    <svg class="h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
    </svg>
    返回订阅列表
  </a>
</div>

@if (loading()) {
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 animate-pulse">
    <!-- Left Column Skeleton -->
    <div class="lg:col-span-2 space-y-8">
      <!-- Plan title skeleton -->
      <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised">
        <div class="h-8 bg-dark/50 rounded w-3/4"></div>
        <div class="mt-4 h-4 bg-dark/50 rounded w-full"></div>
        <div class="mt-2 h-4 bg-dark/50 rounded w-5/6"></div>
      </div>
      <!-- Coupon skeleton -->
      <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised">
        <div class="h-6 bg-dark/50 rounded w-1/4 mb-4"></div>
        <div class="flex gap-3">
          <div class="h-12 bg-dark rounded-xl flex-grow"></div>
          <div class="h-12 w-24 bg-surface rounded-xl shadow-neumorphic-raised"></div>
        </div>
      </div>
      <!-- Period skeleton -->
      <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised">
        <div class="h-6 bg-dark/50 rounded w-1/3 mb-4"></div>
        <div class="space-y-4">
          <div class="h-16 bg-dark rounded-xl"></div>
          <div class="h-16 bg-dark rounded-xl"></div>
        </div>
      </div>
    </div>
    <!-- Right Column Skeleton -->
    <div class="lg:col-span-1">
      <div class="bg-dark p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised sticky top-10">
        <div class="h-6 bg-surface rounded w-1/2 mb-6 border-b border-surface pb-4"></div>
        <div class="space-y-4">
          <div class="flex justify-between"><div class="h-4 bg-surface rounded w-2/3"></div><div class="h-4 bg-surface rounded w-1/4"></div></div>
          <div class="flex justify-between"><div class="h-4 bg-surface rounded w-1/3"></div><div class="h-4 bg-surface rounded w-1/4"></div></div>
        </div>
        <div class="mt-8 h-12 bg-accent-start rounded-xl"></div>
      </div>
    </div>
  </div>
} @else if (error()) {
  <div class="bg-red-900/30 border border-red-500/50 text-red-400 px-4 py-3 rounded-xl" role="alert">
    <strong class="font-bold">错误!</strong>
    <span class="block sm:inline">{{ error() }}</span>
  </div>
} @else if (plan(); as p) {
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
    <!-- Left Column: Configuration -->
    <div class="lg:col-span-2 space-y-8">
      <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised">
        <h1 class="text-3xl font-bold text-text-main">{{ p.name }}</h1>
        <div class="mt-4 text-text-muted">
           <p>配置您的订阅计划，选择最适合您的付款周期。</p>
        </div>
      </div>
      
      <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised">
        <h2 class="text-xl font-semibold text-text-main mb-2">优惠券</h2>
        <div class="flex gap-3">
          <input type="text" placeholder="有优惠券吗？" 
                 [ngModel]="couponCode()" (ngModelChange)="couponCode.set($event)"
                 [disabled]="couponValidation().status === 'success'"
                 class="flex-grow w-full px-4 py-3 bg-dark text-text-main placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-accent-start rounded-xl shadow-neumorphic-sunken transition-shadow disabled:bg-dark/50 disabled:cursor-not-allowed">
          <button (click)="applyCoupon()" [disabled]="couponValidation().status === 'loading' || !couponCode() || couponValidation().status === 'success'"
                  class="px-5 py-2 rounded-xl font-semibold text-text-main transition-all duration-200 ease-in-out shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken bg-surface disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed flex-shrink-0">
            @if (couponValidation().status === 'loading') {
              <svg class="animate-spin h-5 w-5 text-text-main" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
            } @else {
              验证
            }
          </button>
        </div>
         @if (couponValidation().message) {
          <p class="mt-2 text-sm" [class.text-green-400]="couponValidation().status === 'success'" [class.text-red-400]="couponValidation().status === 'error'">
            {{ couponValidation().message }}
          </p>
        }
      </div>
      
       <div class="bg-surface p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised">
        <h2 class="text-xl font-semibold text-text-main mb-4">付款周期</h2>
        <div class="space-y-4">
          @for (period of availablePeriods(); track period.key) {
            <label class="block p-4 rounded-xl transition-all duration-200 cursor-pointer" 
                  [class.bg-dark]="selectedPeriodKey() === period.key"
                  [class.shadow-neumorphic-sunken]="selectedPeriodKey() === period.key"
                  [class.shadow-neumorphic-raised]="selectedPeriodKey() !== period.key"
                  [class.hover:shadow-neumorphic-pressed]="selectedPeriodKey() !== period.key">
              <input type="radio" name="billing-period" class="hidden" [value]="period.key" [checked]="selectedPeriodKey() === period.key" (change)="selectedPeriodKey.set(period.key)">
              <div class="flex justify-between items-center">
                <span class="font-semibold text-text-main">{{ period.name }}</span>
                <span class="font-bold text-lg text-accent-start">¥{{ (period.price / 100).toFixed(2) }}</span>
              </div>
            </label>
          }
        </div>
      </div>
    </div>

    <!-- Right Column: Order Summary -->
    <div class="lg:col-span-1">
      <div class="bg-dark p-6 sm:p-8 rounded-2xl shadow-neumorphic-raised sticky top-10">
        <h2 class="text-xl font-semibold text-text-main mb-6 border-b border-surface pb-4">订单总额</h2>
        <div class="space-y-4">
          <div class="flex justify-between text-text-muted">
            <span>{{ p.name }} ({{ selectedPeriodName() }})</span>
            <span>¥{{ (selectedPeriodPrice() / 100).toFixed(2) }}</span>
          </div>
          @if (discountAmount() > 0) {
            <div class="flex justify-between text-green-400">
              <span>优惠折扣</span>
              <span>- ¥{{ (discountAmount() / 100).toFixed(2) }}</span>
            </div>
          }
          <div class="border-t border-surface my-4"></div>
          <div class="flex justify-between items-baseline text-text-main">
            <span class="font-semibold">总计</span>
            <span class="text-3xl font-bold">¥{{ (finalAmount() / 100).toFixed(2) }}</span>
          </div>
        </div>
        <button (click)="placeOrder()" [disabled]="isPlacingOrder() || !selectedPeriodKey()"
                class="mt-8 w-full py-3 px-4 rounded-xl text-white font-semibold transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 active:translate-y-0.5 bg-gradient-to-br from-accent-start to-accent-end shadow-neumorphic-raised hover:shadow-neumorphic-pressed active:shadow-neumorphic-sunken disabled:from-gray-600 disabled:to-gray-700 disabled:shadow-none disabled:cursor-not-allowed">
            @if (isPlacingOrder()) {
                <div class="flex items-center justify-center">
                  <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                  处理中...
                </div>
              } @else {
                下单
              }
        </button>
      </div>
    </div>
  </div>
}
